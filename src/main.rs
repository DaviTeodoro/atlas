extern crate sdl2;
mod atlas;
mod camera;
mod point;
mod renderer;
mod screen;
mod vertex;

use atlas::Atlas;
use point::Point;
use renderer::render;
use screen::Screen;
use vertex::Vertex;

use geo::CoordsIter;
use geojson::{quick_collection, GeoJson};
use sdl2::event::Event;
use sdl2::keyboard::Keycode;
use sdl2::pixels;

const SCREEN_WIDTH: u32 = 800;
const SCREEN_HEIGHT: u32 = 600;

trait IntoGeometryList {
    fn into_geometry_list(&self, atlas: &Atlas) -> Vec<Vec<Vertex>>;
}
impl IntoGeometryList for GeoJson {
    fn into_geometry_list(&self, atlas: &Atlas) -> Vec<Vec<Vertex>> {
        quick_collection(&self)
            .unwrap()
            .iter()
            .map(|geometry| {
                geometry
                    .coords_iter()
                    .map(|c| atlas.vertex(c.into()))
                    .collect::<Vec<Vertex>>()
            })
            .collect()
    }
}

fn main() -> Result<(), String> {
    let sdl_context = sdl2::init()?;
    let video_subsys = sdl_context.video()?;
    let screen = Screen::new(SCREEN_WIDTH, SCREEN_HEIGHT);
    let atlas = Atlas::new(screen);
    let window = video_subsys
        .window("Atlas", SCREEN_WIDTH, SCREEN_HEIGHT)
        .position_centered()
        .opengl()
        .build()
        .map_err(|e| e.to_string())?;

    let mut is_draging = false;
    let mut canvas = window.into_canvas().build().map_err(|e| e.to_string())?;

    canvas.set_draw_color(pixels::Color::RGB(226, 232, 240));
    canvas.clear();

    let geometry_list: Vec<Vec<Vertex>> = geojson_str()
        .parse::<GeoJson>()
        .unwrap()
        .into_geometry_list(&atlas);

    render(&geometry_list, &mut canvas);

    let mut events = sdl_context.event_pump()?;

    'main: loop {
        for event in events.poll_iter() {
            match event {
                Event::Quit { .. } => break 'main,

                Event::KeyDown {
                    keycode: Some(keycode),
                    ..
                } => {
                    if keycode == Keycode::Escape {
                        break 'main;
                    } else if keycode == Keycode::Space {
                        println!("space down");
                    }
                    canvas.present();
                }

                Event::MouseButtonDown { .. } => {
                    is_draging = true;
                }

                Event::MouseMotion { x, y, .. } => {
                    println!("mouse motion at (x:{},y:{})", x, y);
                    println!("isDraging {}", is_draging);
                    if is_draging {};
                }

                Event::MouseButtonUp { x, y, .. } => {
                    is_draging = false;
                    println!("mouse btn up at (x:{},y:{})", x, y);
                }

                _ => {}
            }
        }
    }

    Ok(())
}

fn geojson_str() -> String {
    r#"
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": {
        "stroke-width": 2,
        "stroke-opacity": 1,
        "fill-opacity": 0.5,
        "name": "Brasil"
      },
      "geometry": {
        "type": "Polygon",
        "coordinates": [
                      [
            [
              -52.20703125,
              -32.842673631954305
            ],
            [
              -50.44921875,
              -30.44867367928756
            ],
            [
              -48.515625,
              -28.30438068296277
            ],
            [
              -48.603515625,
              -25.997549919572098
            ],
            [
              -47.109375,
              -24.5271348225978
            ],
            [
              -44.8681640625,
              -23.443088931121775
            ],
            [
              -43.9892578125,
              -22.958393318086337
            ],
            [
              -42.84667968749999,
              -23.1605633090483
            ],
            [
              -41.87988281249999,
              -22.593726063929296
            ],
            [
              -41.37451171875,
              -22.177231792821342
            ],
            [
              -40.95703125,
              -21.983801417384697
            ],
            [
              -41.055908203125,
              -21.442843107187652
            ],
            [
              -40.528564453125,
              -20.725290873994197
            ],
            [
              -40.220947265625,
              -20.293113447544098
            ],
            [
              -39.891357421875,
              -19.642587534013032
            ],
            [
              -39.7265625,
              -19.207428526801184
            ],
            [
              -39.715576171875,
              -18.63583516062284
            ],
            [
              -39.627685546875,
              -18.145851771694467
            ],
            [
              -39.144287109375,
              -17.675427818339383
            ],
            [
              -39.210205078125,
              -17.23525150539052
            ],
            [
              -38.97949218749999,
              -16.14081555527601
            ],
            [
              -38.902587890625,
              -15.802824941413187
            ],
            [
              -39.00146484375,
              -15.082731671605787
            ],
            [
              -39.056396484375,
              -14.732386081418454
            ],
            [
              -38.97949218749999,
              -14.237762492417659
            ],
            [
              -38.9520263671875,
              -13.2399454992863
            ],
            [
              -38.199462890625,
              -12.88677980084704
            ],
            [
              -37.913818359375,
              -12.46876014482322
            ],
            [
              -37.452392578125,
              -11.662996112308035
            ],
            [
              -37.276611328125,
              -11.221510260010541
            ],
            [
              -36.6943359375,
              -10.617418067950293
            ],
            [
              -36.37573242187499,
              -10.395974612177643
            ],
            [
              -36.23291015625,
              -10.266276060027122
            ],
            [
              -35.8428955078125,
              -9.768611091236483
            ],
            [
              -35.7110595703125,
              -9.67656858750112
            ],
            [
              -35.65063476562499,
              -9.606166114941969
            ],
            [
              -35.4913330078125,
              -9.373192635083441
            ],
            [
              -35.3375244140625,
              -9.215982405510825
            ],
            [
              -35.22216796875,
              -9.03157787963176
            ],
            [
              -35.1507568359375,
              -8.912206892260215
            ],
            [
              -35.1177978515625,
              -8.781939521035971
            ],
            [
              -35.068359375,
              -8.68420891954859
            ],
            [
              -34.9859619140625,
              -8.477805461808186
            ],
            [
              -34.9639892578125,
              -8.363692651835823
            ],
            [
              -34.903564453125,
              -8.211490323420682
            ],
            [
              -34.8651123046875,
              -8.02659484248955
            ],
            [
              -34.82666015625,
              -7.852498637813016
            ],
            [
              -34.8211669921875,
              -7.732765062729807
            ],
            [
              -34.83215332031249,
              -7.5694373362514344
            ],
            [
              -34.8101806640625,
              -7.280741242677959
            ],
            [
              -34.771728515625,
              -7.160850096497242
            ],
            [
              -34.8101806640625,
              -7.002763681982734
            ],
            [
              -34.892578125,
              -6.882800241767556
            ],
            [
              -34.93377685546875,
              -6.798262304540396
            ],
            [
              -34.9639892578125,
              -6.678247482748998
            ],
            [
              -34.99420166015625,
              -6.585488564561947
            ],
            [
              -34.98870849609375,
              -6.356245636365608
            ],
            [
              -35.07659912109375,
              -6.208820977124995
            ],
            [
              -35.1177978515625,
              -5.971217057997224
            ],
            [
              -35.16448974609375,
              -5.883796361755705
            ],
            [
              -35.2001953125,
              -5.692515936746771
            ],
            [
              -35.24139404296874,
              -5.512107462769789
            ],
            [
              -35.36224365234374,
              -5.337113527125014
            ],
            [
              -35.5517578125,
              -5.123772299948803
            ],
            [
              -35.92529296875,
              -5.069057826784033
            ],
            [
              -36.397705078125,
              -5.112829778499449
            ],
            [
              -36.683349609375,
              -5.145656780300514
            ],
            [
              -37.177734375,
              -4.937724274302479
            ],
            [
              -37.50732421875,
              -4.455950571647079
            ],
            [
              -38.16650390625,
              -4.171115454867424
            ],
            [
              -38.47412109375,
              -3.688855143147035
            ],
            [
              -38.97949218749999,
              -3.35988909487339
            ],
            [
              -39.6826171875,
              -3.008869978848142
            ],
            [
              -40.31982421875,
              -2.8772079526533365
            ],
            [
              -41.28662109375,
              -2.943040910055132
            ],
            [
              -41.748046875,
              -2.986927393334863
            ],
            [
              -43.33007812499999,
              -2.3723687086440504
            ],
            [
              -44.560546875,
              -2.064982495867104
            ],
            [
              -46.142578125,
              -1.098565496040652
            ],
            [
              -47.4609375,
              -0.7909904981540058
            ],
            [
              -48.603515625,
              -0.4833927027896987
            ],
            [
              -50.71289062499999,
              -0.08789059053082422
            ],
            [
              -50.1416015625,
              1.3182430568620136
            ],
            [
              -50.8447265625,
              3.0746950723696944
            ],
            [
              -51.67968749999999,
              4.214943141390651
            ],
            [
              -52.734375,
              2.3723687086440504
            ],
            [
              -55.283203125,
              2.28455066023697
            ],
            [
              -56.33789062499999,
              1.7575368113083254
            ],
            [
              -57.919921875,
              1.6696855009865839
            ],
            [
              -59.150390625,
              1.4939713066293239
            ],
            [
              -60.380859375,
              2.8991526985043135
            ],
            [
              -59.58984374999999,
              4.390228926463396
            ],
            [
              -60.380859375,
              5.266007882805498
            ],
            [
              -62.22656249999999,
              3.9519408561575946
            ],
            [
              -64.86328125,
              3.8642546157214084
            ],
            [
              -62.9296875,
              1.7575368113083254
            ],
            [
              -65.7421875,
              0.7031073524364909
            ],
            [
              -67.1484375,
              1.5818302639606454
            ],
            [
              -70.13671875,
              1.2303741774326145
            ],
            [
              -70.13671875,
              -0.4394488164139641
            ],
            [
              -69.60937499999999,
              -1.7575368113083125
            ],
            [
              -69.60937499999999,
              -4.127285323245357
            ],
            [
              -71.71875,
              -4.302591077119676
            ],
            [
              -73.037109375,
              -5.7908968128719565
            ],
            [
              -73.740234375,
              -7.18810087117902
            ],
            [
              -73.388671875,
              -9.188870084473393
            ],
            [
              -71.3671875,
              -9.88227549342994
            ],
            [
              -70.224609375,
              -10.40137755454354
            ],
            [
              -66.357421875,
              -10.40137755454354
            ],
            [
              -64.072265625,
              -12.554563528593656
            ],
            [
              -62.13867187499999,
              -13.2399454992863
            ],
            [
              -60.732421875,
              -14.179186142354169
            ],
            [
              -59.853515625,
              -16.13026201203474
            ],
            [
              -58.00781249999999,
              -17.308687886770024
            ],
            [
              -57.65624999999999,
              -18.979025953255267
            ],
            [
              -58.27148437499999,
              -20.055931265194438
            ],
            [
              -57.74414062500001,
              -22.350075806124853
            ],
            [
              -56.07421875,
              -22.512556954051437
            ],
            [
              -55.107421875,
              -23.88583769986199
            ],
            [
              -54.052734375,
              -24.607069137709694
            ],
            [
              -53.525390625,
              -26.11598592533351
            ],
            [
              -53.96484375,
              -27.761329874505233
            ],
            [
              -56.51367187499999,
              -29.458731185355315
            ],
            [
              -58.00781249999999,
              -30.29701788337204
            ],
            [
              -56.953125,
              -30.44867367928756
            ],
            [
              -56.33789062499999,
              -30.67571540416773
            ],
            [
              -54.4921875,
              -31.353636941500987
            ],
            [
              -52.20703125,
              -32.842673631954305
            ]
          ]
        ]
      }
    }
  ]
}
"#
    .to_owned()
}
